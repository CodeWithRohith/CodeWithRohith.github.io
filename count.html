<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Earnings Timer</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col items-center justify-center p-6">
    <div class="w-full max-w-md bg-white rounded-xl shadow-md p-6 fade-in">
        <h1 class="text-2xl font-semibold text-center text-indigo-600 mb-6">Earnings Timer</h1>

        <!-- Loading State (shown by default) -->
        <div id="loadingScreen" class="text-center">
            <p class="text-gray-500">Loading timer...</p>
        </div>

        <!-- Start Timer Section (hidden by default) -->
        <div id="startScreen" class="hidden">
            <label for="hourlyPay" class="block text-sm font-medium text-gray-700 mb-1">Hourly Rate ($)</label>
            <input type="number" id="hourlyPay" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="15.50" min="0" step="0.01">
            <button id="startBtn" class="w-full bg-indigo-600 text-white font-medium py-2 rounded-lg mt-4 hover:bg-indigo-700 transition">
                Start Timer
            </button>
        </div>

        <!-- Timer Running Section (hidden by default) -->
        <div id="timerScreen" class="hidden text-center">
            <div class="mb-4">
                <p class="text-sm text-gray-500">Hourly Rate</p>
                <p class="text-lg font-bold">$<span id="currentRateDisplay">0.00</span>/hr</p>
            </div>
            <div class="mb-4">
                <p class="text-sm text-gray-500">Time Worked</p>
                <p class="text-2xl font-bold"><span id="timerDisplay">00:00:00</span></p>
            </div>
            <div class="mb-6">
                <p class="text-sm text-gray-500">Earnings</p>
                <p class="text-2xl font-bold text-green-600">$<span id="earningsDisplay">0.00</span></p>
            </div>
            <button id="stopBtn" class="w-full bg-red-600 text-white font-medium py-2 rounded-lg hover:bg-red-700 transition">
                Stop Timer
            </button>
        </div>

        <!-- Error State (hidden by default) -->
        <div id="errorScreen" class="hidden text-center text-red-500">
            <p>Failed to load timer. Please try again.</p>
            <button onclick="window.location.reload()" class="mt-2 text-sm text-indigo-600">
                Reload Page
            </button>
        </div>
    </div>

    <!-- History Section -->
    <div class="w-full max-w-md bg-white rounded-xl shadow-md p-6 mt-4">
        <h2 class="text-lg font-semibold text-center text-gray-700 mb-4">History</h2>
        <div id="historyLoading" class="text-center text-gray-500">Loading history...</div>
        <ul id="historyList" class="hidden mt-2 space-y-3"></ul>
    </div>

    <script>
        const API_BASE_URL = 'https://timer-mo2c.onrender.com';
        const state = {
            timerInterval: null,
            elapsedSeconds: 0,
            activeSessionId: null,
            hourlyRate: 0
        };

        const elements = {
            loadingScreen: document.getElementById('loadingScreen'),
            startScreen: document.getElementById('startScreen'),
            timerScreen: document.getElementById('timerScreen'),
            errorScreen: document.getElementById('errorScreen'),
            startBtn: document.getElementById('startBtn'),
            stopBtn: document.getElementById('stopBtn'),
            hourlyPay: document.getElementById('hourlyPay'),
            timerDisplay: document.getElementById('timerDisplay'),
            earningsDisplay: document.getElementById('earningsDisplay'),
            currentRateDisplay: document.getElementById('currentRateDisplay'),
            historyList: document.getElementById('historyList'),
            historyLoading: document.getElementById('historyLoading')
        };

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', initializeApp);

        async function initializeApp() {
            try {
                // First check for active session
                await checkForActiveSession();
                
                // Then load history
                await loadHistory();
                
            } catch (error) {
                console.error('Initialization error:', error);
                showErrorState();
            }
        }

        async function checkForActiveSession() {
            try {
                const response = await axios.get(`${API_BASE_URL}/timer/active_status`);
                
                if (response.data?.active) {
                    // Active session found
                    state.activeSessionId = response.data.session_id;
                    state.hourlyRate = response.data.hourly_pay;
                    state.elapsedSeconds = Math.floor(response.data.elapsed_seconds);
                    
                    // Update UI for active session
                    elements.currentRateDisplay.textContent = state.hourlyRate.toFixed(2);
                    elements.hourlyPay.value = state.hourlyRate;
                    
                    // Show timer screen and start counting
                    showTimerScreen();
                    startTimerDisplay();
                } else {
                    // No active session - show start screen
                    showStartScreen();
                }
                
            } catch (error) {
                console.error('Error checking active session:', error);
                throw error;
            }
        }

        async function startTimer() {
            const rate = parseFloat(elements.hourlyPay.value);
            if (!rate || rate <= 0) {
                alert('Please enter a valid hourly rate');
                return;
            }

            try {
                // Disable button during request
                elements.startBtn.disabled = true;
                elements.startBtn.innerHTML = `
                    <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Starting...
                `;
                
                const response = await axios.post(`${API_BASE_URL}/timer/start`, { 
                    hourly_pay: rate 
                });
                
                if (response.data.status === 'already_running') {
                    alert('A timer is already running');
                    return;
                }

                // Update state with new session
                state.activeSessionId = response.data.session_id;
                state.hourlyRate = rate;
                state.elapsedSeconds = 0;
                
                // Update UI
                elements.currentRateDisplay.textContent = rate.toFixed(2);
                showTimerScreen();
                startTimerDisplay();
                
            } catch (error) {
                console.error('Start timer failed:', error);
                alert('Failed to start timer: ' + (error.response?.data?.error || error.message));
            } finally {
                // Re-enable button
                elements.startBtn.disabled = false;
                elements.startBtn.textContent = 'Start Timer';
            }
        }

        async function stopTimer() {
            if (!state.activeSessionId) return;

            try {
                // Disable button during request
                elements.stopBtn.disabled = true;
                elements.stopBtn.innerHTML = `
                    <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Stopping...
                `;
                
                // Call stop endpoint
                await axios.post(`${API_BASE_URL}/timer/stop`);
                
                // Reset state
                state.activeSessionId = null;
                clearInterval(state.timerInterval);
                
                // Update UI
                showStartScreen();
                
                // Refresh history
                await loadHistory();
                
            } catch (error) {
                console.error('Stop timer failed:', error);
                alert('Failed to stop timer: ' + (error.response?.data?.error || error.message));
            } finally {
                // Re-enable button
                elements.stopBtn.disabled = false;
                elements.stopBtn.textContent = 'Stop Timer';
            }
        }

        function showStartScreen() {
            elements.loadingScreen.classList.add('hidden');
            elements.timerScreen.classList.add('hidden');
            elements.errorScreen.classList.add('hidden');
            elements.startScreen.classList.remove('hidden');
        }

        function showTimerScreen() {
            elements.loadingScreen.classList.add('hidden');
            elements.startScreen.classList.add('hidden');
            elements.errorScreen.classList.add('hidden');
            elements.timerScreen.classList.remove('hidden');
        }

        function showErrorState() {
            elements.loadingScreen.classList.add('hidden');
            elements.startScreen.classList.add('hidden');
            elements.timerScreen.classList.add('hidden');
            elements.errorScreen.classList.remove('hidden');
        }

        function startTimerDisplay() {
            // Clear any existing interval
            if (state.timerInterval) {
                clearInterval(state.timerInterval);
            }
            
            // Update immediately
            updateTimerDisplay();
            
            // Then update every second
            state.timerInterval = setInterval(updateTimerDisplay, 1000);
        }

        function updateTimerDisplay() {
            const hours = Math.floor(state.elapsedSeconds / 3600);
            const minutes = Math.floor((state.elapsedSeconds % 3600) / 60);
            const seconds = state.elapsedSeconds % 60;
            
            // Update time display
            elements.timerDisplay.textContent = 
                `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            
            // Update earnings display
            elements.earningsDisplay.textContent = 
                ((state.elapsedSeconds / 3600) * state.hourlyRate).toFixed(2);
            
            // Increment for next second
            state.elapsedSeconds++;
        }

        async function loadHistory() {
            try {
                elements.historyList.classList.add('hidden');
                elements.historyLoading.classList.remove('hidden');
                
                const response = await axios.get(`${API_BASE_URL}/timer/history`);
                const sessions = response.data;

                elements.historyList.innerHTML = "";
                
                if (sessions.length === 0) {
                    elements.historyList.innerHTML = `
                        <li class="text-center text-gray-400 py-4">
                            No timer history yet
                        </li>
                    `;
                } else {
                    sessions.forEach(session => {
                        const startTime = new Date(session.start_time).toLocaleString();
                        const endTime = new Date(session.end_time).toLocaleString();
                        const hoursWorked = (new Date(session.end_time) - new Date(session.start_time);
                        const hours = (hoursWorked / 3600000).toFixed(2);
                        
                        const item = document.createElement('li');
                        item.className = "bg-gray-50 p-3 rounded-md border border-gray-200";
                        item.innerHTML = `
                            <div class="flex justify-between items-start">
                                <div>
                                    <span class="font-bold">$${session.hourly_pay.toFixed(2)}/hr</span>
                                    <span class="text-xs text-gray-500 ml-2">${hours} hours</span>
                                </div>
                                <span class="font-bold text-green-600">$${session.total_pay.toFixed(2)}</span>
                            </div>
                            <div class="text-xs text-gray-500 mt-1">
                                <div>${startTime} to ${endTime}</div>
                            </div>
                        `;
                        elements.historyList.appendChild(item);
                    });
                }
                
                elements.historyLoading.classList.add('hidden');
                elements.historyList.classList.remove('hidden');
                
            } catch (error) {
                console.error("Error loading history:", error);
                elements.historyLoading.innerHTML = `
                    <div class="text-red-500">
                        Failed to load history. <button onclick="loadHistory()" class="text-indigo-600">Retry</button>
                    </div>
                `;
            }
        }

        // Set up event listeners
        elements.startBtn.addEventListener('click', startTimer);
        elements.stopBtn.addEventListener('click', stopTimer);
    </script>
</body>
</html>